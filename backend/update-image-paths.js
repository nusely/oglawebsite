const fs = require('fs');
const path = require('path');

// Load the URL mapping generated by bulk-upload-to-cloudinary.js
const mappingFile = path.join(__dirname, 'cloudinary-url-mapping.json');

if (!fs.existsSync(mappingFile)) {
  console.error('âŒ URL mapping file not found. Please run bulk-upload-to-cloudinary.js first.');
  process.exit(1);
}

const urlMapping = JSON.parse(fs.readFileSync(mappingFile, 'utf8'));

function updateFile(filePath) {
  try {
    let content = fs.readFileSync(filePath, 'utf8');
    let hasChanges = false;
    
    // Replace all image paths
    Object.entries(urlMapping).forEach(([oldPath, newUrl]) => {
      const regex = new RegExp(oldPath.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      if (content.includes(oldPath)) {
        content = content.replace(regex, newUrl);
        hasChanges = true;
        console.log(`  âœ… Replaced: ${oldPath} â†’ ${newUrl}`);
      }
    });
    
    if (hasChanges) {
      fs.writeFileSync(filePath, content);
      console.log(`ğŸ“ Updated: ${filePath}`);
      return true;
    }
    
    return false;
  } catch (error) {
    console.error(`âŒ Error updating ${filePath}:`, error.message);
    return false;
  }
}

function walkAndUpdate(dir, extensions = ['.js', '.jsx', '.ts', '.tsx', '.json']) {
  const items = fs.readdirSync(dir);
  let totalUpdates = 0;
  
  for (const item of items) {
    const fullPath = path.join(dir, item);
    
    // Skip node_modules and other irrelevant directories
    if (item === 'node_modules' || item === '.git' || item === 'build' || item === 'dist') {
      continue;
    }
    
    if (fs.statSync(fullPath).isDirectory()) {
      totalUpdates += walkAndUpdate(fullPath, extensions);
    } else if (extensions.some(ext => item.endsWith(ext))) {
      if (updateFile(fullPath)) {
        totalUpdates++;
      }
    }
  }
  
  return totalUpdates;
}

async function main() {
  console.log('ğŸ”„ Updating image paths in codebase...');
  console.log(`ğŸ“Š Found ${Object.keys(urlMapping).length} URL mappings to apply`);
  
  // Update frontend files
  const frontendPath = path.join(__dirname, '../frontend/src');
  const backendPath = path.join(__dirname, '../backend');
  
  console.log('\nğŸ“‚ Updating frontend files...');
  const frontendUpdates = walkAndUpdate(frontendPath);
  
  console.log('\nğŸ“‚ Updating backend files...');
  const backendUpdates = walkAndUpdate(backendPath);
  
  console.log(`\nğŸ‰ Complete! Updated ${frontendUpdates + backendUpdates} files total.`);
  
  // Show summary
  console.log('\nğŸ“‹ What happened:');
  console.log(`  â€¢ Uploaded ${Object.keys(urlMapping).length} images to Cloudinary`);
  console.log(`  â€¢ Updated ${frontendUpdates} frontend files`);
  console.log(`  â€¢ Updated ${backendUpdates} backend files`);
  console.log('  â€¢ All /images/ paths now point to Cloudinary URLs');
  
  console.log('\nâš ï¸  Important: Test your application to make sure everything works!');
}

main();
